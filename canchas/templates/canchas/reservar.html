{% extends 'canchas/base.html' %}
{% load custom_filters %}

{% block title %}Reservar {{ cancha.nombre }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-calendar-plus"></i> Reservar Cancha</h4>
            </div>
            <div class="card-body">
                <!-- Imagen de la cancha -->
                {% if cancha.imagen %}
                <div class="mb-4">
                    <img src="{{ cancha.imagen.url }}" 
                         class="img-fluid rounded shadow-sm" 
                         alt="{{ cancha.nombre }}"
                         style="max-height: 300px; width: 100%; object-fit: cover;">
                </div>
                {% endif %}
                
                <div class="mb-4">
                    <h5><i class="bi bi-trophy-fill text-success"></i> {{ cancha.nombre }}</h5>
                    <p class="text-muted">{{ cancha.descripcion }}</p>
                    
                    <!-- Precio por hora -->
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-currency-dollar"></i> <strong>Precio por hora:</strong>
                        </div>
                        <div>
                            <h4 class="mb-0 text-success">${{ cancha.precio_por_hora|formato_precio }} COP</h4>
                        </div>
                    </div>
                </div>
                
                {% if reservas_existentes %}
                <!-- Filtro de búsqueda rápida -->
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtro Rápido de Disponibilidad</h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-4 mb-2">
                                <label for="filtroFecha" class="form-label">Fecha</label>
                                <input type="date" id="filtroFecha" class="form-control" placeholder="Selecciona fecha">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="filtroHora" class="form-label">Hora de Inicio</label>
                                <select id="filtroHora" class="form-control">
                                    <option value="">Todas las horas</option>
                                    <option value="08:00">08:00 AM</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">01:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                    <option value="18:00">06:00 PM</option>
                                    <option value="19:00">07:00 PM</option>
                                    <option value="20:00">08:00 PM</option>
                                    <option value="21:00">09:00 PM</option>
                                    <option value="22:00">10:00 PM</option>
                                    <option value="23:00">11:00 PM</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button id="btnFiltrar" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Buscar Disponibilidad
                                </button>
                            </div>
                        </div>
                        <div id="resultadoFiltro" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Tabla oculta para que JavaScript pueda leer las reservas -->
                <table class="d-none" id="tablaReservas">
                    <tbody>
                        {% for reserva in reservas_existentes %}
                        <tr data-fecha="{{ reserva.fecha|date:'Y-m-d' }}" data-hora-inicio="{{ reserva.hora_inicio }}">
                            <td>{{ reserva.fecha|date:"d/m/Y" }}</td>
                            <td>{{ reserva.hora_inicio }} - {{ reserva.hora_fin }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> Esta cancha no tiene reservas activas. ¡Todos los horarios están disponibles!
                </div>
                {% endif %}
                
                <hr>
                
                <form method="post">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="{{ form.fecha.id_for_label }}" class="form-label">
                            <i class="bi bi-calendar-event"></i> {{ form.fecha.label }}
                        </label>
                        {{ form.fecha }}
                        {% if form.fecha.errors %}
                            <div class="text-danger">{{ form.fecha.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Selecciona la fecha en la que deseas reservar.</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.hora_inicio.id_for_label }}" class="form-label">
                                <i class="bi bi-clock"></i> {{ form.hora_inicio.label }}
                            </label>
                            {{ form.hora_inicio }}
                            {% if form.hora_inicio.errors %}
                                <div class="text-danger">{{ form.hora_inicio.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.hora_fin.id_for_label }}" class="form-label">
                                <i class="bi bi-clock-fill"></i> {{ form.hora_fin.label }}
                            </label>
                            {{ form.hora_fin }}
                            {% if form.hora_fin.errors %}
                                <div class="text-danger">{{ form.hora_fin.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Cálculo de Costo Total -->
                    <div id="costoTotal" class="alert alert-success d-none mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <strong><i class="bi bi-hourglass-split"></i> Duración:</strong>
                                <span id="duracionHoras">0</span> hora(s)
                            </div>
                            <div class="col-md-6 text-end">
                                <strong><i class="bi bi-cash-coin"></i> Costo Total:</strong>
                                <h4 class="mb-0 text-success d-inline ms-2" id="costoTotalValor">$0</h4>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Confirmar Reserva
                        </button>
                        <a href="{% url 'lista_canchas' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnFiltrar = document.getElementById('btnFiltrar');
    const filtroFecha = document.getElementById('filtroFecha');
    const filtroHora = document.getElementById('filtroHora');
    const resultadoFiltro = document.getElementById('resultadoFiltro');
    const tablaReservas = document.getElementById('tablaReservas');
    
    if (btnFiltrar) {
        btnFiltrar.addEventListener('click', function() {
            const fechaSeleccionada = filtroFecha.value;
            const horaSeleccionada = filtroHora.value;
            
            if (!fechaSeleccionada) {
                resultadoFiltro.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Por favor selecciona una fecha.</div>';
                return;
            }
            
            // Obtener todas las filas de la tabla
            const filas = tablaReservas.querySelectorAll('tbody tr');
            let reservasEncontradas = [];
            
            filas.forEach(function(fila) {
                const fecha = fila.getAttribute('data-fecha');
                const horaInicio = fila.getAttribute('data-hora-inicio');
                
                // Filtrar por fecha y opcionalmente por hora
                if (fecha === fechaSeleccionada) {
                    if (!horaSeleccionada || horaInicio === horaSeleccionada) {
                        reservasEncontradas.push({
                            fecha: fila.querySelector('td:nth-child(1)').textContent,
                            horario: fila.querySelector('td:nth-child(2)').textContent
                        });
                    }
                }
            });
            
            // Mostrar resultados
            if (reservasEncontradas.length > 0) {
                let html = '<div class="alert alert-danger">';
                html += '<h6><i class="bi bi-x-circle"></i> Horarios NO disponibles:</h6>';
                html += '<ul class="mb-0">';
                reservasEncontradas.forEach(function(reserva) {
                    html += '<li>' + reserva.horario + '</li>';
                });
                html += '</ul>';
                html += '</div>';
                resultadoFiltro.innerHTML = html;
            } else {
                let mensaje = '<div class="alert alert-success">';
                mensaje += '<h6><i class="bi bi-check-circle"></i> ¡Horario disponible!</h6>';
                if (horaSeleccionada) {
                    const horaFormateada = formatearHora(horaSeleccionada);
                    mensaje += '<p class="mb-0">El horario desde las <strong>' + horaFormateada + '</strong> está disponible para la fecha seleccionada.</p>';
                } else {
                    mensaje += '<p class="mb-0">Todos los horarios están disponibles para la fecha seleccionada.</p>';
                }
                mensaje += '</div>';
                resultadoFiltro.innerHTML = mensaje;
            }
        });
    }
    
    // Función para formatear hora en formato 12 horas
    function formatearHora(hora24) {
        const [horas, minutos] = hora24.split(':');
        const h = parseInt(horas);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return h12 + ':' + minutos + ' ' + ampm;
    }
    
    // ===== CALCULADORA DE COSTO TOTAL =====
    const horaInicio = document.getElementById('{{ form.hora_inicio.id_for_label }}');
    const horaFin = document.getElementById('{{ form.hora_fin.id_for_label }}');
    const costoTotalDiv = document.getElementById('costoTotal');
    const duracionSpan = document.getElementById('duracionHoras');
    const costoTotalSpan = document.getElementById('costoTotalValor');
    const precioPorHora = {{ cancha.precio_por_hora }};
    
    function calcularCosto() {
        const inicio = horaInicio.value;
        const fin = horaFin.value;
        
        if (inicio && fin) {
            // Convertir horas a números
            let horaInicioNum = parseInt(inicio.split(':')[0]);
            let horaFinNum = parseInt(fin.split(':')[0]);
            
            // Manejar el caso de medianoche (00:00)
            if (horaFinNum === 0) {
                horaFinNum = 24;
            }
            
            // Calcular duración
            const duracion = horaFinNum - horaInicioNum;
            
            if (duracion > 0) {
                const costoTotal = duracion * precioPorHora;
                
                // Actualizar la interfaz
                duracionSpan.textContent = duracion;
                costoTotalSpan.textContent = '$' + costoTotal.toLocaleString('es-CO');
                costoTotalDiv.classList.remove('d-none');
            } else {
                costoTotalDiv.classList.add('d-none');
            }
        } else {
            costoTotalDiv.classList.add('d-none');
        }
    }
    
    // Escuchar cambios en los selects
    if (horaInicio && horaFin) {
        horaInicio.addEventListener('change', calcularCosto);
        horaFin.addEventListener('change', calcularCosto);
        
        // Calcular al cargar si ya hay valores seleccionados
        calcularCosto();
    }
});
</script>
{% endblock %}
